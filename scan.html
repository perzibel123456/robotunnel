<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>סריקה רציפה - ROBOTUNNEL</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <style>
        body { background-color: #f8f9fa; font-family: sans-serif; margin: 0; overflow: hidden; }
        
        /* Navbar עיצוב */
        .navbar-brand img { margin-left: 10px; }
        
        /* אזור התצוגה התלת-מימדית */
        #canvas-container { 
            position: absolute; top: 70px; left: 0; width: 100%; height: calc(100% - 70px); 
            background: #0b0f14; 
        }

        /* פאנל נתונים צף */
        .info-panel { 
            position: absolute; top: 90px; right: 20px; z-index: 10; 
            background: rgba(26, 26, 26, 0.9); color: #e0e0e0; 
            padding: 15px; border-radius: 12px; border: 1px solid #444; min-width: 200px;
        }
        .val { color: #0d6efd; font-weight: bold; font-family: monospace; }
        .btn-reset { background-color: #ffc107; color: black; font-weight: bold; width: 100%; border: none; margin-top: 10px; padding: 5px; border-radius: 5px; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
  <div class="container">
    <a class="navbar-brand d-flex align-items-center" href="index.html">
      <img src="logo.png" alt="Logo" width="70" class="ms-2"> ROBOTUNNEL
    </a>
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="index.html">בית</a></li>
        <li class="nav-item"><a class="nav-link" href="control.html">שליטה</a></li>
        <li class="nav-item"><a class="nav-link active" href="scan.html">סריקה תלת-מימדית</a></li>
      </ul>
    </div>
  </div>
</nav>

<div id="canvas-container"></div>

<div class="info-panel text-center">
    <h6>נתוני סריקה (Altera)</h6>
    <hr>
    <div>Right: <span id="valA" class="val">--</span></div>
    <div>Up: <span id="valB" class="val">--</span></div>
    <div>Left: <span id="valC" class="val">--</span></div>
    <button class="btn-reset" onclick="location.reload()">איפוס סריקה</button>
</div>

<script>
    // 1. אתחול Firebase
    const firebaseConfig = {
        databaseURL: "https://rubotunnel-default-rtdb.firebaseio.com",
        projectId: "rubotunnel",
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // 2. אתחול Three.js
    const container = document.getElementById('canvas-container');
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    container.appendChild(renderer.domElement);

    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    camera.position.set(0, 5, 12);

    // תאורה (חיוני למשטחים)
    scene.add(new THREE.AmbientLight(0xffffff, 0.6));
    const light = new THREE.PointLight(0x00f2ff, 1);
    camera.add(light);
    scene.add(camera);

    // הגדרת המעטפת (Mesh)
    const MAX_VERTICES = 200000;
    const geometry = new THREE.BufferGeometry();
    const positions = new Float32Array(MAX_VERTICES * 3);
    const indices = [];
    geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
    const material = new THREE.MeshPhongMaterial({ color: 0x00f2ff, side: THREE.DoubleSide, flatShading: true, transparent: true, opacity: 0.8 });
    const tunnelMesh = new THREE.Mesh(geometry, material);
    scene.add(tunnelMesh);

    // --- הוספת מישור אופקי (Horizontal Plane) ---
    const planeGeom = new THREE.PlaneGeometry(20, 3);
    const planeMat = new THREE.MeshBasicMaterial({ color: 0x00f2ff, side: THREE.DoubleSide, transparent: true, opacity: 0.3 });
    const horizontalPlane = new THREE.Mesh(planeGeom, planeMat);
    horizontalPlane.rotation.x = Math.PI / 2;
    scene.add(horizontalPlane);

    scene.add(new THREE.GridHelper(100, 50, 0x333333, 0x222222));

    let lastPoints = null, currentZ = 0, vertexIdx = 0;
    let lastData = { A: 0, B: 0, C: 0 };

    // 3. לוגיקת סרטוט רציף
    function drawSolidLayer(A, B, C) {
        const resolution = 20;
        const width = A + C;
        const centerShift = (A - C) / 2;
        let newPoints = [];

        for (let i = 0; i <= resolution; i++) {
            const t = i / resolution;
            const x = -C + (width * t);
            const y = B * (1 - Math.pow((x - centerShift) / (width / 2 + 0.0001), 2));
            
            positions[vertexIdx * 3] = x;
            positions[vertexIdx * 3 + 1] = Math.max(0, y);
            positions[vertexIdx * 3 + 2] = currentZ;
            newPoints.push(new THREE.Vector3(x, y, currentZ));
            vertexIdx++;
        }

        if (lastPoints !== null) {
            const startOld = vertexIdx - (resolution + 1) * 2;
            const startNew = vertexIdx - (resolution + 1);
            for (let i = 0; i < resolution; i++) {
                indices.push(startOld + i, startNew + i, startOld + i + 1);
                indices.push(startNew + i, startNew + i + 1, startOld + i + 1);
            }
            geometry.setIndex(indices);
        }

        lastPoints = newPoints;
        geometry.attributes.position.needsUpdate = true;
        geometry.computeVertexNormals();

        // עדכון המישור האופקי
        horizontalPlane.position.z = currentZ;
        horizontalPlane.position.x = centerShift;
        horizontalPlane.scale.x = (A + C) / 10;

        currentZ -= 1.5; // התקדמות כל 3 שניות
    }

    // 4. תקשורת וניהול זמן
    database.ref('fromAltera').on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            lastData = data;
            document.getElementById('valA').innerText = data.A;
            document.getElementById('valB').innerText = data.B;
            document.getElementById('valC').innerText = data.C;
        }
    });

    setInterval(() => {
        const a = parseFloat(lastData.A), b = parseFloat(lastData.B), c = parseFloat(lastData.C);
        if (a > 0 || b > 0 || c > 0) drawSolidLayer(a, b, c);
    }, 3000);

    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
    }
    animate();

    window.addEventListener('resize', () => {
        camera.aspect = container.clientWidth / container.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(container.clientWidth, container.clientHeight);
    });
</script>
</body>
</html>
