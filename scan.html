<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>סריקה תלת-מימדית - ROBOTUNNEL</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <style>
        /* הגדרות בסיסיות למניעת גלילת דפדפן וניצול מקסימלי של שטח המסך */
        body { background-color: #f8f9fa; margin: 0; overflow: hidden; font-family: sans-serif; }
        
        /* Canvas Container: המיכל שבו Three.js מצייר את המודל. תופס 100% מגובה המסך */
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100vh; background: #0b0f14; }
        
        /* פאנל מידע רספונסיבי: משתנה בין מחשב לטלפון */
        .info-panel { 
            position: absolute; 
            z-index: 10; 
            background: rgba(20, 20, 20, 0.95); /* רקע כהה כמעט אטום */
            color: #e0e0e0; 
            padding: 20px; 
            border-radius: 20px; 
            border: 2px solid #ffc107; /* מסגרת צהובה בולטת */
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }

        /* עיצוב למחשבים: הפאנל ממוקם בצד ימין למעלה */
        @media (min-width: 768px) {
            .info-panel { top: 100px; right: 30px; width: 320px; }
        }

        /* עיצוב לטלפונים: הפאנל נצמד לתחתית כדי לא להסתיר את המודל */
        @media (max-width: 767px) {
            .info-panel { bottom: 20px; left: 10px; right: 10px; padding: 15px; }
            .val { font-size: 1.6rem !important; } /* הקטנת פונט קלה להתאמה למסך קטן */
        }

        .info-panel h4 { color: #ffc107; font-weight: bold; margin-bottom: 15px; }
        
        /* עיצוב הערכים המספריים: טורקיז בולט, פונט מונוספייס (רוחב קבוע) למניעת קפיצות טקסט */
        .val { color: #00f2ff; font-weight: bold; font-family: monospace; font-size: 2rem; display: block; }
        
        .btn-custom { font-weight: bold; width: 100%; border: none; padding: 12px; border-radius: 12px; transition: 0.3s; }
        .btn-stop { background-color: #dc3545; color: white; }
        .btn-success { background-color: #198754; color: white; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top shadow">
  <div class="container">
    <a class="navbar-brand d-flex align-items-center fw-bold" href="index.html">
      <img src="logo.png" alt="Logo" width="50" class="ms-2"> ROBOTUNNEL
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="index.html">בית</a></li>
        <li class="nav-item"><a class="nav-link" href="control.html">שליטה</a></li>
        <li class="nav-item"><a class="nav-link active" href="scan.html">סריקה</a></li>
      </ul>
    </div>
  </div>
</nav>

<div id="canvas-container"></div>

<div class="info-panel text-center container-fluid">
    <h4><i class="bi bi-broadcast"></i> נתוני סריקה</h4>
    <div class="row g-2">
        <div class="col-6 col-md-12">
            <div class="small text-secondary">רוחב (ס"מ)</div>
            <span id="display-width" class="val">0</span>
        </div>
        <div class="col-6 col-md-12">
            <div class="small text-secondary">גובה (ס"מ)</div>
            <span id="display-height" class="val">0</span>
        </div>
    </div>
    <div class="row g-2 mt-2">
        <div class="col-6 col-md-12">
            <button id="stopBtn" class="btn-custom btn-success" onclick="toggleScanning()">
                <i class="bi bi-play-fill"></i>
            </button>
        </div>
        <div class="col-6 col-md-12">
            <button class="btn-custom btn-secondary" onclick="location.reload()">
                <i class="bi bi-arrow-clockwise"></i>
            </button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // --- 1. הגדרות Firebase ותקשורת ---
    const firebaseConfig = { 
        databaseURL: "https://rubotunnel-default-rtdb.firebaseio.com", 
        projectId: "rubotunnel" 
    };
    // אתחול האפליקציה רק אם היא לא קיימת בזיכרון
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // --- 2. אתחול מנוע גרפי Three.js ---
    const container = document.getElementById('canvas-container');
    const scene = new THREE.Scene(); // יצירת מרחב תלת-מימדי ריק
    
    // מצלמה בפרספקטיבה: מדמה עין אנושית (Far plane = 2000 לטווח סריקה ארוך)
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);
    const renderer = new THREE.WebGLRenderer({ antialias: true }); // מנוע רינדור חומרה להחלקת פיקסלים
    renderer.setSize(window.innerWidth, window.innerHeight);
    container.appendChild(renderer.domElement); // הזרקת ה-Canvas ל-HTML

    // controls: מאפשר סיבוב וזום של המודל עם העכבר/אצבע
    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    camera.position.set(150, 200, -500); // הגדרת נקודת מבט רחוקה וגבוהה (Perspective)
    controls.update();

    // הוספת תאורה: Ambient להארה כללית ו-PointLight שצמודה למצלמה (כמו פנס חוקר)
    scene.add(new THREE.AmbientLight(0xffffff, 0.4));
    const pointLight = new THREE.PointLight(0x00f2ff, 1.2);
    camera.add(pointLight); 
    scene.add(camera);

    /**
     * בניית הגיאומטריה של המנהרה באמצעות BufferGeometry.
     * שימוש במערך Float32Array לשמירת נקודות XYZ - השיטה היעילה ביותר לעיבוד ב-GPU.
     */
    const geometry = new THREE.BufferGeometry();
    const positions = new Float32Array(300000); // מקום ל-100,000 נקודות תלת-מימדיות
    const indices = []; // מערך המגדיר אילו נקודות מתחברות למשולשים (Faces)
    geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
    
    // הגדרת החומר (Material): טורקיז, מגיב לאור, שקוף למחצה
    const material = new THREE.MeshPhongMaterial({ 
        color: 0x00f2ff, side: THREE.DoubleSide, flatShading: true, transparent: true, opacity: 0.8 
    });
    const tunnelMesh = new THREE.Mesh(geometry, material); // שילוב צורה וחומר
    scene.add(tunnelMesh); // הוספת המנהרה לבמה
    
    // הוספת רשת עזר (Grid) ענקית להתמצאות במרחב
    scene.add(new THREE.GridHelper(500, 100, 0x333333, 0x222222));

    // משתני עזר לניהול מצב הסריקה
    let lastPoints = null; // שמירת השכבה הקודמת כדי לחבר אותה לנוכחית
    let currentZ = 0;      // העומק הנוכחי במרחב הווירטואלי
    let vertexIdx = 0;     // סופר כמה קואורדינטות נכתבו למערך ה-Positions
    let isScanning = false;
    const ROBOT_WIDTH = 25; // תיקון הנדסי קבוע לרוחב גוף הרובוט

    /**
     * פונקציית drawSolidLayer: הופכת נתוני מרחק לצורה גיאומטרית.
     * משתמשת בנוסחת פרבולה לחישוב קשת המנהרה.
     */
    function drawSolidLayer(A, B, C) {
        const resolution = 20; // מספר הנקודות המרכיבות את הקשת (דיוק)
        const totalWidth = A + C + ROBOT_WIDTH; // חישוב רוחב מנהרה אמיתי
        const centerShift = (A - C) / 2; // היסט המרכז במידה והרובוט לא בקו האמצע
        let newPoints = [];

        // לולאת חישוב נקודות XYZ עבור שכבה אחת
        for (let i = 0; i <= resolution; i++) {
            const t = i / resolution; // התקדמות לאורך הרוחב (0 עד 1)
            const x = -(totalWidth / 2) + (totalWidth * t) + centerShift; // חישוב מיקום X
            
            // נוסחת הפרבולה: גובה B בשיא, ו-0 בקצוות (הרצפה)
            const y = B * (1 - Math.pow((x - centerShift) / (totalWidth / 2 + 0.0001), 2));
            
            positions[vertexIdx * 3] = x;     // X
            positions[vertexIdx * 3 + 1] = Math.max(0, y); // Y
            positions[vertexIdx * 3 + 2] = currentZ;       // Z (עומק)
            
            newPoints.push(new THREE.Vector3(x, y, currentZ)); // שמירת הנקודה כווקטור
            vertexIdx++;
        }

        // חיבור השכבה הנוכחית לשכבה הקודמת ליצירת נפח (Mesh)
        if (lastPoints !== null) {
            const startOld = vertexIdx - (resolution + 1) * 2;
            const startNew = vertexIdx - (resolution + 1);
            for (let i = 0; i < resolution; i++) {
                // יצירת שני משולשים המרכיבים מרובע אחד במעטפת המנהרה
                indices.push(startOld + i, startNew + i, startOld + i + 1);
                indices.push(startNew + i, startNew + i + 1, startOld + i + 1);
            }
            geometry.setIndex(indices); // עדכון החיבורים בגיאומטריה
        }

        lastPoints = newPoints; // השכבה הזו תהיה ה"ישנה" בפעם הבאה
        geometry.attributes.position.needsUpdate = true; // פקודה ל-GPU לרענן את הנקודות
        geometry.computeVertexNormals(); // חישוב הצללה ריאליסטית לפי הנורמלים של המשטח
        currentZ -= 2; // התקדמות העומק הווירטואלי ב-2 יחידות לכל פעימת מידע

        // עדכון המספרים המחושבים בפאנל המידע למשתמש
        document.getElementById('display-width').innerText = totalWidth.toFixed(1);
        document.getElementById('display-height').innerText = B.toFixed(1);
    }

    /**
     * ניהול מצבי עבודה (State Management):
     * הפעלה/עצירת הרובוט והסרטוט.
     */
    function toggleScanning() {
        const btn = document.getElementById('stopBtn');
        if (!isScanning) {
            isScanning = true;
            database.ref('toAltera').set(192); // שליחת פקודת ריצה אוטו' + סריקה
            btn.innerHTML = '<i class="bi bi-pause-fill"></i>'; // שינוי לאייקון עצירה
            btn.classList.replace('btn-success', 'btn-stop');
        } else {
            isScanning = false;
            database.ref('toAltera').set(0); // שליחת פקודת עצירה מוחלטת
            btn.innerHTML = '<i class="bi bi-play-fill"></i>'; // שינוי לאייקון הפעלה
            btn.classList.replace('btn-stop', 'btn-success');
        }
    }

    // האזנה ל-Firebase: מופעל בכל פעם שמתקבל נתון חדש מה-Altera
    database.ref('fromAltera').on('value', (snapshot) => {
        const data = snapshot.val();
        // סרטוט יתבצע רק אם המשתמש הפעיל את מצב הסריקה
        if (data && isScanning) {
            const a = parseFloat(data.A), b = parseFloat(data.B), c = parseFloat(data.C);
            if (a > 0 || b > 0 || c > 0) drawSolidLayer(a, b, c);
        }
    });

    // הפעלה אוטומטית של הסריקה מיד עם טעינת הדף (UX חלקי)
    window.onload = () => { if (!isScanning) toggleScanning(); };

    // לולאת הרינדור הראשית (60 פעמים בשנייה)
    function animate() { 
        requestAnimationFrame(animate); 
        controls.update(); // עדכון מצב המצלמה לפי תנועת המשתמש
        renderer.render(scene, camera); // ציור הסצנה מחדש על המסך
    }
    animate();

    // טיפול בשינוי גודל חלון (רספונסיביות של ה-Canvas)
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });
</script>
</body>
</html>
